<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Harvest - Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        :root {
            --color-bg: #0f172a;
            --color-bg-secondary: #1e293b;
            --color-bg-tertiary: #334155;
            --color-text: #f1f5f9;
            --color-text-secondary: #cbd5e1;
            --color-text-muted: #94a3b8;
            --color-primary: #10b981;
            --color-primary-hover: #059669;
            --color-accent: #f59e0b;
            --color-danger: #ef4444;
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
        }

        .card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-bg-tertiary);
            border-radius: 0.75rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--color-bg-secondary), var(--color-bg-tertiary));
        }

        .nav-tab {
            transition: all 0.2s ease;
        }
        .nav-tab:hover {
            background: var(--color-bg-tertiary);
        }
        .nav-tab.active {
            background: var(--color-primary);
            color: white;
        }

        .event-badge {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .product-row:hover {
            background: var(--color-bg-tertiary);
        }

        .advance-btn {
            transition: all 0.2s ease;
        }
        .advance-btn:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .event-log {
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            border-left: 3px solid var(--color-primary);
            padding-left: 1rem;
            margin-bottom: 0.5rem;
        }

        .log-entry.sale { border-color: #22c55e; }
        .log-entry.delivery { border-color: #3b82f6; }
        .log-entry.event { border-color: #f59e0b; }
        .log-entry.expense { border-color: #ef4444; }
    </style>
</head>
<body class="font-sans min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Tab definitions
        const TABS = {
            DASHBOARD: 'dashboard',
            PRODUCTS: 'products',
            SUPPLIERS: 'suppliers',
            ORDERS: 'orders',
            ANALYTICS: 'analytics',
            FINANCIALS: 'financials'
        };

        function App() {
            const [businessId, setBusinessId] = useState(null);
            const [businessName, setBusinessName] = useState('');
            const [gameState, setGameState] = useState(null);
            const [financials, setFinancials] = useState(null);
            const [products, setProducts] = useState([]);
            const [vendors, setVendors] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [events, setEvents] = useState([]);
            const [orders, setOrders] = useState([]);
            const [eventLog, setEventLog] = useState([]);
            const [activeTab, setActiveTab] = useState(TABS.DASHBOARD);
            const [loading, setLoading] = useState(true);
            const [advancing, setAdvancing] = useState(false);
            const [daysToAdvance, setDaysToAdvance] = useState(1);

            useEffect(() => {
                // Get business from localStorage
                const storedId = localStorage.getItem('selectedBusinessId');
                const storedName = localStorage.getItem('selectedBusinessName');

                if (!storedId) {
                    window.location.href = '/select-business';
                    return;
                }

                setBusinessId(parseInt(storedId));
                setBusinessName(storedName || 'Your Business');
                loadGameData(parseInt(storedId));
            }, []);

            const loadGameData = async (bizId) => {
                setLoading(true);
                try {
                    const [stateRes, financialsRes, productsRes, vendorsRes, inventoryRes, eventsRes, ordersRes] = await Promise.all([
                        fetch(`/api/game/state?business_id=${bizId}`, { credentials: 'include' }),
                        fetch(`/api/game/financials?business_id=${bizId}`, { credentials: 'include' }),
                        fetch(`/api/game/products?business_id=${bizId}`, { credentials: 'include' }),
                        fetch(`/api/game/vendors?business_id=${bizId}`, { credentials: 'include' }),
                        fetch(`/api/game/inventory?business_id=${bizId}`, { credentials: 'include' }),
                        fetch('/api/game/events', { credentials: 'include' }),
                        fetch(`/api/game/purchase_orders?business_id=${bizId}`, { credentials: 'include' })
                    ]);

                    if (stateRes.status === 401) {
                        window.location.href = '/login';
                        return;
                    }

                    setGameState(await stateRes.json());
                    setFinancials(await financialsRes.json());
                    setProducts(await productsRes.json());
                    setVendors(await vendorsRes.json());
                    setInventory(await inventoryRes.json());
                    setEvents(await eventsRes.json());
                    setOrders(await ordersRes.json());
                } catch (err) {
                    console.error('Failed to load game data:', err);
                }
                setLoading(false);
            };

            const advanceTime = async () => {
                if (advancing || !businessId) return;

                setAdvancing(true);
                try {
                    const res = await fetch('/api/game/advance_time', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ business_id: businessId, days: daysToAdvance })
                    });

                    const data = await res.json();
                    if (data.success) {
                        // Process results into event log
                        const newLogs = [];
                        data.results.forEach(day => {
                            // Sales
                            day.sales.forEach(sale => {
                                newLogs.push({
                                    type: 'sale',
                                    date: day.date,
                                    text: `Sold ${sale.units_sold} ${sale.product_name} for $${sale.revenue.toFixed(2)}`
                                });
                            });
                            // Deliveries
                            day.deliveries?.forEach(del => {
                                newLogs.push({
                                    type: 'delivery',
                                    date: day.date,
                                    text: `Received delivery: ${del.items?.length || 0} items`
                                });
                            });
                            // Events
                            day.events_started?.forEach(evt => {
                                newLogs.push({
                                    type: 'event',
                                    date: day.date,
                                    text: `Market Event: ${evt.name} - ${evt.description}`
                                });
                            });
                        });

                        setEventLog(prev => [...newLogs, ...prev].slice(0, 100));
                        await loadGameData(businessId);
                    }
                } catch (err) {
                    console.error('Failed to advance time:', err);
                }
                setAdvancing(false);
            };

            const restartGame = async () => {
                if (!businessId) return;

                if (!confirm('Are you sure you want to restart this game? All progress will be lost!')) {
                    return;
                }

                try {
                    const res = await fetch('/api/game/restart', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ business_id: businessId })
                    });

                    const data = await res.json();
                    if (data.success) {
                        setEventLog([{ type: 'system', date: new Date().toISOString().split('T')[0], text: data.message }]);
                        await loadGameData(businessId);
                    } else {
                        alert('Failed to restart: ' + data.message);
                    }
                } catch (err) {
                    console.error('Failed to restart game:', err);
                    alert('Failed to restart game');
                }
            };

            const formatMoney = (amount) => {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(amount || 0);
            };

            const formatNumber = (num) => {
                return new Intl.NumberFormat('en-US').format(num || 0);
            };

            // Toast notification state
            const [toast, setToast] = useState(null);
            const showToast = (message, type = 'info') => {
                setToast({ message, type });
                setTimeout(() => setToast(null), 4000);
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr + 'T12:00:00');
                return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-4xl mb-4 animate-bounce">üåæ</div>
                            <p className="text-gray-400">Loading game...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen">
                    {/* Toast Notification */}
                    {toast && (
                        <div className={`fixed top-4 right-4 z-[100] px-6 py-4 rounded-lg shadow-xl transition-all ${
                            toast.type === 'success' ? 'bg-green-600' :
                            toast.type === 'error' ? 'bg-red-600' : 'bg-blue-600'
                        }`}>
                            <div className="flex items-center gap-3">
                                <span className="text-xl">
                                    {toast.type === 'success' ? '‚úì' : toast.type === 'error' ? '‚úï' : '‚Ñπ'}
                                </span>
                                <span className="text-white font-medium">{toast.message}</span>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <header className="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <h1 className="text-xl font-bold text-green-400">{businessName}</h1>
                                <span className="text-gray-400">|</span>
                                <span className="text-gray-300">{formatDate(gameState?.current_game_date)}</span>
                            </div>

                            <div className="flex items-center gap-4">
                                {/* Cash Display */}
                                <div className="text-right">
                                    <div className="text-xs text-gray-400">Cash</div>
                                    <div className="text-lg font-mono text-green-400">{formatMoney(financials?.cash)}</div>
                                </div>

                                {/* Time Advance Controls */}
                                <div className="flex items-center gap-2">
                                    <select
                                        value={daysToAdvance}
                                        onChange={(e) => setDaysToAdvance(parseInt(e.target.value))}
                                        className="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm"
                                    >
                                        <option value={1}>1 Day</option>
                                        <option value={7}>1 Week</option>
                                        <option value={30}>1 Month</option>
                                    </select>
                                    <button
                                        onClick={advanceTime}
                                        disabled={advancing}
                                        className="advance-btn bg-green-600 hover:bg-green-500 px-4 py-2 rounded font-semibold disabled:opacity-50"
                                    >
                                        {advancing ? '‚è≥' : '‚ñ∂Ô∏è'} Advance
                                    </button>
                                </div>

                                {/* Change Business */}
                                <a href="/select-business" className="text-gray-400 hover:text-white text-sm">
                                    Change Business
                                </a>

                                {/* Restart Game */}
                                <button
                                    onClick={restartGame}
                                    className="text-red-400 hover:text-red-300 text-sm"
                                    title="Restart this business from scratch"
                                >
                                    Restart Game
                                </button>
                            </div>
                        </div>

                        {/* Navigation Tabs */}
                        <div className="max-w-7xl mx-auto px-4">
                            <nav className="flex gap-1">
                                {Object.entries(TABS).map(([key, value]) => (
                                    <button
                                        key={value}
                                        onClick={() => setActiveTab(value)}
                                        className={`nav-tab px-4 py-2 rounded-t text-sm font-medium ${activeTab === value ? 'active' : 'text-gray-400'}`}
                                    >
                                        {key.charAt(0) + key.slice(1).toLowerCase()}
                                    </button>
                                ))}
                            </nav>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 py-6">
                        {/* Active Events Banner */}
                        {events.length > 0 && (
                            <div className="mb-6 p-4 bg-yellow-900/30 border border-yellow-600/50 rounded-lg">
                                <h3 className="text-yellow-400 font-semibold mb-2">Active Market Events</h3>
                                <div className="flex flex-wrap gap-4">
                                    {events.map((evt, i) => (
                                        <div key={i} className="event-badge bg-yellow-800/50 px-3 py-1 rounded-full text-sm">
                                            <span className="font-semibold">{evt.name}</span>
                                            <span className="text-yellow-200/70 ml-2">until {evt.end_date}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === TABS.DASHBOARD && (
                            <DashboardTab
                                financials={financials}
                                inventory={inventory}
                                products={products}
                                eventLog={eventLog}
                                formatMoney={formatMoney}
                            />
                        )}

                        {activeTab === TABS.PRODUCTS && (
                            <ProductsTab
                                products={products}
                                businessId={businessId}
                                onUpdate={() => loadGameData(businessId)}
                                formatMoney={formatMoney}
                            />
                        )}

                        {activeTab === TABS.SUPPLIERS && (
                            <SuppliersTab
                                vendors={vendors}
                                businessId={businessId}
                                onOrderPlaced={() => loadGameData(businessId)}
                                formatMoney={formatMoney}
                                formatNumber={formatNumber}
                                showToast={showToast}
                            />
                        )}

                        {activeTab === TABS.ORDERS && (
                            <OrdersTab
                                orders={orders}
                                formatMoney={formatMoney}
                            />
                        )}

                        {activeTab === TABS.ANALYTICS && (
                            <AnalyticsTab
                                businessId={businessId}
                                formatMoney={formatMoney}
                                formatNumber={formatNumber}
                            />
                        )}

                        {activeTab === TABS.FINANCIALS && (
                            <FinancialsTab
                                financials={financials}
                                apDetails={financials?.accounts_payable_details || []}
                                formatMoney={formatMoney}
                            />
                        )}
                    </main>
                </div>
            );
        }

        // Dashboard Tab Component
        function DashboardTab({ financials, inventory, products, eventLog, formatMoney }) {
            const [showHelp, setShowHelp] = useState(() => {
                return !localStorage.getItem('dh_help_dismissed');
            });

            const dismissHelp = () => {
                setShowHelp(false);
                localStorage.setItem('dh_help_dismissed', 'true');
            };

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    {/* Getting Started Guide */}
                    {showHelp && (
                        <div className="lg:col-span-3 card p-5 border-2 border-green-500/30 bg-gradient-to-r from-green-900/20 to-transparent">
                            <div className="flex justify-between items-start">
                                <h3 className="font-bold text-lg text-green-400 mb-3">üéÆ How to Play Digital Harvest</h3>
                                <button onClick={dismissHelp} className="text-gray-500 hover:text-white text-xl">√ó</button>
                            </div>
                            <div className="grid md:grid-cols-4 gap-4 text-sm">
                                <div className="space-y-1">
                                    <div className="text-green-400 font-semibold">1. Buy Inventory</div>
                                    <p className="text-gray-400">Go to <span className="text-white">Suppliers</span> tab ‚Üí Pick a vendor ‚Üí Order products</p>
                                </div>
                                <div className="space-y-1">
                                    <div className="text-blue-400 font-semibold">2. Wait for Delivery</div>
                                    <p className="text-gray-400">Orders take days to arrive. Check lead times before ordering!</p>
                                </div>
                                <div className="space-y-1">
                                    <div className="text-yellow-400 font-semibold">3. Advance Time</div>
                                    <p className="text-gray-400">Click <span className="text-white">Advance</span> to progress days. Products sell automatically!</p>
                                </div>
                                <div className="space-y-1">
                                    <div className="text-purple-400 font-semibold">4. Grow Your Business</div>
                                    <p className="text-gray-400">Watch for market events. Adjust prices. Unlock better vendors!</p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Stats Cards */}
                    <div className="lg:col-span-2 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="stat-card card p-4">
                            <div className="text-gray-400 text-sm">Cash</div>
                            <div className="text-2xl font-bold text-green-400">{formatMoney(financials?.cash)}</div>
                        </div>
                        <div className="stat-card card p-4">
                            <div className="text-gray-400 text-sm">Revenue</div>
                            <div className="text-2xl font-bold text-blue-400">{formatMoney(financials?.revenue)}</div>
                        </div>
                        <div className="stat-card card p-4">
                            <div className="text-gray-400 text-sm">Gross Profit</div>
                            <div className={`text-2xl font-bold ${financials?.gross_profit >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                {formatMoney(financials?.gross_profit)}
                            </div>
                        </div>
                        <div className="stat-card card p-4">
                            <div className="text-gray-400 text-sm">Net Worth</div>
                            <div className="text-2xl font-bold text-purple-400">{formatMoney(financials?.net_worth)}</div>
                        </div>
                    </div>

                    {/* Inventory Summary */}
                    <div className="card p-4">
                        <h3 className="font-semibold mb-3">Inventory Value</h3>
                        <div className="text-3xl font-bold text-cyan-400 mb-2">
                            {formatMoney(financials?.inventory_value)}
                        </div>
                        <div className="text-sm text-gray-400">
                            {inventory.length} products in stock
                        </div>
                    </div>

                    {/* Low Stock Alerts */}
                    <div className="card p-4">
                        <h3 className="font-semibold mb-3 text-yellow-400">Low Stock Alerts</h3>
                        <div className="space-y-2">
                            {products.filter(p => (p.stock || 0) < 10).slice(0, 5).map(p => (
                                <div key={p.product_id} className="flex justify-between text-sm">
                                    <span className="text-gray-300">{p.name}</span>
                                    <span className="text-red-400 font-mono">{p.stock || 0} left</span>
                                </div>
                            ))}
                            {products.filter(p => (p.stock || 0) < 10).length === 0 && (
                                <p className="text-gray-500 text-sm">All products well stocked!</p>
                            )}
                        </div>
                    </div>

                    {/* Event Log */}
                    <div className="lg:col-span-2 card p-4">
                        <h3 className="font-semibold mb-3">Recent Activity</h3>
                        <div className="event-log space-y-2">
                            {eventLog.length === 0 ? (
                                <p className="text-gray-500 text-sm">Advance time to see activity...</p>
                            ) : (
                                eventLog.slice(0, 20).map((log, i) => (
                                    <div key={i} className={`log-entry ${log.type} text-sm`}>
                                        <span className="text-gray-500">{log.date}</span>
                                        <span className="ml-2 text-gray-300">{log.text}</span>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Products Tab Component
        function ProductsTab({ products, businessId, onUpdate, formatMoney }) {
            const [editingPrice, setEditingPrice] = useState(null);
            const [newPrice, setNewPrice] = useState('');

            const updatePrice = async (productId) => {
                try {
                    const res = await fetch(`/api/game/products/${productId}/price`, {
                        method: 'PUT',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ price: parseFloat(newPrice) })
                    });
                    if (res.ok) {
                        setEditingPrice(null);
                        onUpdate();
                    }
                } catch (err) {
                    console.error('Failed to update price:', err);
                }
            };

            const getDaysSupplyColor = (days) => {
                if (days === null || days === undefined) return 'text-gray-500';
                if (days < 3) return 'text-red-400';
                if (days < 7) return 'text-yellow-400';
                return 'text-green-400';
            };

            const getDaysSupplyLabel = (days) => {
                if (days === null || days === undefined) return '-';
                if (days < 3) return `${days.toFixed(1)}d ‚ö†Ô∏è`;
                return `${days.toFixed(1)}d`;
            };

            return (
                <div className="card overflow-hidden">
                    <table className="w-full">
                        <thead className="bg-gray-700">
                            <tr>
                                <th className="text-left p-3">Product</th>
                                <th className="text-left p-3">Category</th>
                                <th className="text-right p-3">Stock</th>
                                <th className="text-right p-3">Days Supply</th>
                                <th className="text-right p-3">Default Price</th>
                                <th className="text-right p-3">Your Price</th>
                                <th className="text-right p-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {products.map(product => (
                                <tr key={product.product_id} className="product-row border-t border-gray-700">
                                    <td className="p-3">
                                        <div className="font-medium">{product.name}</div>
                                        <div className="text-xs text-gray-500">{product.description}</div>
                                    </td>
                                    <td className="p-3 text-gray-400">{product.category_name || '-'}</td>
                                    <td className="p-3 text-right">
                                        <div className={`font-mono ${(product.stock || 0) < 10 ? 'text-red-400' : 'text-green-400'}`}>
                                            {new Intl.NumberFormat('en-US').format(product.stock || 0)}
                                        </div>
                                        {product.on_order > 0 && (
                                            <div className="text-xs text-cyan-400">+{product.on_order} ordered</div>
                                        )}
                                    </td>
                                    <td className={`p-3 text-right font-mono ${getDaysSupplyColor(product.days_supply)}`}>
                                        {getDaysSupplyLabel(product.days_supply)}
                                    </td>
                                    <td className="p-3 text-right text-gray-400 font-mono">
                                        {formatMoney(product.default_price)}
                                    </td>
                                    <td className="p-3 text-right">
                                        {editingPrice === product.product_id ? (
                                            <input
                                                type="number"
                                                step="0.01"
                                                value={newPrice}
                                                onChange={(e) => setNewPrice(e.target.value)}
                                                className="w-24 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-right"
                                                autoFocus
                                                onKeyPress={(e) => e.key === 'Enter' && updatePrice(product.product_id)}
                                            />
                                        ) : (
                                            <span className="font-mono text-green-400">
                                                {formatMoney(product.current_price || product.default_price)}
                                            </span>
                                        )}
                                    </td>
                                    <td className="p-3 text-right">
                                        {editingPrice === product.product_id ? (
                                            <div className="flex gap-2 justify-end">
                                                <button
                                                    onClick={() => updatePrice(product.product_id)}
                                                    className="text-green-400 hover:text-green-300"
                                                >
                                                    Save
                                                </button>
                                                <button
                                                    onClick={() => setEditingPrice(null)}
                                                    className="text-gray-400 hover:text-gray-300"
                                                >
                                                    Cancel
                                                </button>
                                            </div>
                                        ) : (
                                            <button
                                                onClick={() => {
                                                    setEditingPrice(product.product_id);
                                                    setNewPrice(product.current_price || product.default_price);
                                                }}
                                                className="text-blue-400 hover:text-blue-300 text-sm"
                                            >
                                                Edit Price
                                            </button>
                                        )}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }

        // Suppliers Tab Component
        function SuppliersTab({ vendors, businessId, onOrderPlaced, formatMoney, formatNumber, showToast }) {
            const [selectedVendor, setSelectedVendor] = useState(null);
            const [vendorProducts, setVendorProducts] = useState([]);
            const [orderItems, setOrderItems] = useState({});
            const [ordering, setOrdering] = useState(false);
            const mountedRef = useRef(true);

            useEffect(() => {
                return () => { mountedRef.current = false; };
            }, []);

            const loadVendorProducts = async (vendorId) => {
                try {
                    const res = await fetch(`/api/game/vendors/${vendorId}/products`, { credentials: 'include' });
                    const data = await res.json();
                    if (mountedRef.current) {
                        setVendorProducts(data);
                        setOrderItems({});
                    }
                } catch (err) {
                    console.error('Failed to load vendor products:', err);
                }
            };

            const selectVendor = (vendor) => {
                setSelectedVendor(vendor);
                loadVendorProducts(vendor.vendor_id);
            };

            const updateQuantity = (productId, quantity) => {
                setOrderItems(prev => ({
                    ...prev,
                    [productId]: Math.max(0, parseInt(quantity) || 0)
                }));
            };

            const calculateTotal = () => {
                return vendorProducts.reduce((sum, p) => {
                    const qty = orderItems[p.product_id] || 0;
                    return sum + (qty * parseFloat(p.unit_cost));
                }, 0);
            };

            const getMinOrder = () => parseFloat(selectedVendor?.minimum_order_value || 0);

            const placeOrder = async () => {
                const items = Object.entries(orderItems)
                    .filter(([_, qty]) => qty > 0)
                    .map(([productId, quantity]) => ({ product_id: parseInt(productId), quantity }));

                if (items.length === 0) return;

                setOrdering(true);
                try {
                    const res = await fetch('/api/game/purchase_order', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ vendor_id: selectedVendor.vendor_id, items })
                    });

                    const data = await res.json();
                    if (!mountedRef.current) return;

                    if (data.success) {
                        setOrderItems({});
                        onOrderPlaced();
                        showToast(`Order placed! Arriving ${data.order.expected_arrival}`, 'success');
                    } else {
                        showToast(data.message, 'error');
                    }
                } catch (err) {
                    console.error('Failed to place order:', err);
                    if (mountedRef.current) showToast('Failed to place order', 'error');
                }
                if (mountedRef.current) setOrdering(false);
            };

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    {/* Vendor List */}
                    <div className="card p-4">
                        <h3 className="font-semibold mb-4">Vendors</h3>
                        <div className="space-y-2">
                            {vendors.map(vendor => (
                                <button
                                    key={vendor.vendor_id}
                                    onClick={() => selectVendor(vendor)}
                                    className={`w-full text-left p-3 rounded ${
                                        selectedVendor?.vendor_id === vendor.vendor_id
                                            ? 'bg-green-600'
                                            : 'bg-gray-700 hover:bg-gray-600'
                                    }`}
                                >
                                    <div className="font-medium">{vendor.name}</div>
                                    <div className="text-xs text-gray-400">
                                        Min order: {formatMoney(vendor.minimum_order_value)} | Lead time: {vendor.base_lead_time_days} days
                                    </div>
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Vendor Products & Order Form */}
                    <div className="lg:col-span-2 card p-4">
                        {selectedVendor ? (
                            <>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-semibold">{selectedVendor.name} Products</h3>
                                    <div className="text-sm text-gray-400">
                                        Payment: {selectedVendor.payment_terms}
                                    </div>
                                </div>

                                <table className="w-full mb-4">
                                    <thead className="text-left text-gray-400 text-sm">
                                        <tr>
                                            <th className="pb-2">Product</th>
                                            <th className="pb-2 text-center">Stock</th>
                                            <th className="pb-2 text-center">Days Supply</th>
                                            <th className="pb-2 text-right">Unit Cost</th>
                                            <th className="pb-2 text-right">Quantity</th>
                                            <th className="pb-2 text-right">Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {vendorProducts.map(product => {
                                            const daysSupply = product.days_supply;
                                            const daysSupplyColor = daysSupply === null ? 'text-gray-500' :
                                                daysSupply < 3 ? 'text-red-400' :
                                                daysSupply < 7 ? 'text-yellow-400' : 'text-green-400';
                                            const daysSupplyLabel = daysSupply === null ? '‚àû' :
                                                daysSupply.toFixed(1) + 'd';

                                            return (
                                                <tr key={product.product_id} className="border-t border-gray-700">
                                                    <td className="py-2">
                                                        <div>{product.name}</div>
                                                        {product.on_order > 0 && (
                                                            <div className="text-xs text-blue-400">+{product.on_order} on order</div>
                                                        )}
                                                    </td>
                                                    <td className="py-2 text-center font-mono">
                                                        {formatNumber(product.stock || 0)}
                                                    </td>
                                                    <td className={`py-2 text-center font-mono ${daysSupplyColor}`}>
                                                        {daysSupplyLabel}
                                                    </td>
                                                    <td className="py-2 text-right font-mono text-gray-400">
                                                        {formatMoney(product.unit_cost)}
                                                    </td>
                                                    <td className="py-2 text-right">
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            value={orderItems[product.product_id] || ''}
                                                            onChange={(e) => updateQuantity(product.product_id, e.target.value)}
                                                            className="w-20 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-right"
                                                            placeholder="0"
                                                        />
                                                    </td>
                                                    <td className="py-2 text-right font-mono text-green-400">
                                                        {formatMoney((orderItems[product.product_id] || 0) * product.unit_cost)}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>

                                <div className="flex justify-between items-center pt-4 border-t border-gray-700">
                                    <div>
                                        <div className="text-gray-400 text-sm">Order Total</div>
                                        <div className={`text-2xl font-bold ${calculateTotal() >= getMinOrder() || calculateTotal() === 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {formatMoney(calculateTotal())}
                                        </div>
                                        {calculateTotal() > 0 && calculateTotal() < getMinOrder() && (
                                            <div className="text-red-400 text-sm mt-1">
                                                ‚ö†Ô∏è Below minimum order of {formatMoney(getMinOrder())}
                                            </div>
                                        )}
                                        {calculateTotal() === 0 && getMinOrder() > 0 && (
                                            <div className="text-gray-500 text-sm mt-1">
                                                Minimum order: {formatMoney(getMinOrder())}
                                            </div>
                                        )}
                                    </div>
                                    <button
                                        onClick={placeOrder}
                                        disabled={ordering || calculateTotal() === 0 || calculateTotal() < getMinOrder()}
                                        className="bg-green-600 hover:bg-green-500 disabled:bg-gray-600 disabled:cursor-not-allowed px-6 py-3 rounded font-semibold"
                                    >
                                        {ordering ? 'Placing Order...' : 'Place Order'}
                                    </button>
                                </div>
                            </>
                        ) : (
                            <p className="text-gray-500 text-center py-12">Select a vendor to view products</p>
                        )}
                    </div>
                </div>
            );
        }

        // Orders Tab Component
        function OrdersTab({ orders, formatMoney }) {
            return (
                <div className="card overflow-hidden">
                    <table className="w-full">
                        <thead className="bg-gray-700">
                            <tr>
                                <th className="text-left p-3">Order ID</th>
                                <th className="text-left p-3">Vendor</th>
                                <th className="text-left p-3">Order Date</th>
                                <th className="text-left p-3">Expected Arrival</th>
                                <th className="text-center p-3">Status</th>
                                <th className="text-right p-3">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {orders.length === 0 ? (
                                <tr>
                                    <td colSpan="6" className="p-8 text-center text-gray-500">
                                        No purchase orders yet. Visit Suppliers to place orders.
                                    </td>
                                </tr>
                            ) : (
                                orders.map(order => (
                                    <tr key={order.order_id} className="border-t border-gray-700 hover:bg-gray-700/50">
                                        <td className="p-3 font-mono text-gray-400">#{order.order_id}</td>
                                        <td className="p-3">{order.vendor_name}</td>
                                        <td className="p-3 text-gray-400">{order.order_date}</td>
                                        <td className="p-3 text-gray-400">{order.expected_arrival_date}</td>
                                        <td className="p-3 text-center">
                                            <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                                order.status === 'DELIVERED' ? 'bg-green-600' :
                                                order.status === 'IN_TRANSIT' ? 'bg-blue-600' :
                                                'bg-gray-600'
                                            }`}>
                                                {order.status}
                                            </span>
                                        </td>
                                        <td className="p-3 text-right font-mono text-green-400">
                                            {formatMoney(order.total_amount)}
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            );
        }

        // Analytics Tab Component
        function AnalyticsTab({ businessId, formatMoney, formatNumber }) {
            const [analytics, setAnalytics] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const revenueChartRef = React.useRef(null);
            const unitsChartRef = React.useRef(null);
            const chartInstances = React.useRef({});

            useEffect(() => {
                loadAnalytics();
            }, [businessId]);

            // Build charts when analytics data changes
            useEffect(() => {
                if (analytics?.daily_history && analytics.daily_history.length > 0) {
                    // Small delay to ensure canvas elements are mounted
                    const timer = setTimeout(() => {
                        buildCharts();
                    }, 100);
                    return () => clearTimeout(timer);
                }
                // Cleanup charts on unmount
                return () => {
                    Object.values(chartInstances.current).forEach(chart => chart?.destroy());
                };
            }, [analytics]);

            const buildCharts = () => {
                if (!analytics?.daily_history || analytics.daily_history.length === 0) {
                    console.log('No daily history data for charts');
                    return;
                }

                const history = analytics.daily_history;
                const labels = history.map(d => d.date.slice(5)); // MM-DD format

                console.log('Building charts with', history.length, 'data points');

                // Destroy existing charts
                Object.values(chartInstances.current).forEach(chart => chart?.destroy());

                // Check if Chart.js is available
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js not loaded');
                    return;
                }

                // Revenue & Profit Chart
                console.log('Revenue chart ref:', revenueChartRef.current);
                console.log('Units chart ref:', unitsChartRef.current);

                if (revenueChartRef.current) {
                    const ctx = revenueChartRef.current.getContext('2d');
                    chartInstances.current.revenue = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Revenue',
                                    data: history.map(d => d.revenue),
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    fill: true,
                                    tension: 0.3,
                                },
                                {
                                    label: 'Gross Profit',
                                    data: history.map(d => d.profit),
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    fill: true,
                                    tension: 0.3,
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#9ca3af' } }
                            },
                            scales: {
                                x: { ticks: { color: '#6b7280' }, grid: { color: '#374151' } },
                                y: {
                                    ticks: {
                                        color: '#6b7280',
                                        callback: (val) => '$' + val.toLocaleString()
                                    },
                                    grid: { color: '#374151' }
                                }
                            }
                        }
                    });
                }

                // Units Sold Chart
                if (unitsChartRef.current) {
                    const ctx = unitsChartRef.current.getContext('2d');
                    chartInstances.current.units = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Units Sold',
                                data: history.map(d => d.units),
                                backgroundColor: '#8b5cf6',
                                borderRadius: 4,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#9ca3af' } }
                            },
                            scales: {
                                x: { ticks: { color: '#6b7280' }, grid: { color: '#374151' } },
                                y: { ticks: { color: '#6b7280' }, grid: { color: '#374151' } }
                            }
                        }
                    });
                }
            };

            const loadAnalytics = async () => {
                if (!businessId) return;
                setLoading(true);
                try {
                    const res = await fetch(`/api/game/analytics?business_id=${businessId}`, { credentials: 'include' });
                    if (!res.ok) throw new Error('Failed to load analytics');
                    const data = await res.json();
                    setAnalytics(data);
                    setError(null);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const getDaysSupplyColor = (days) => {
                if (days === null || days === undefined) return 'text-gray-400';
                if (days < 3) return 'text-red-400';
                if (days < 7) return 'text-yellow-400';
                return 'text-green-400';
            };

            const getDaysSupplyLabel = (days) => {
                if (days === null || days === undefined) return 'N/A';
                if (days < 3) return `${days.toFixed(1)}d ‚ö†Ô∏è`;
                if (days < 7) return `${days.toFixed(1)}d`;
                return `${days.toFixed(1)}d ‚úì`;
            };

            if (loading) {
                return (
                    <div className="flex justify-center items-center py-12">
                        <div className="text-gray-400">Loading analytics...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="card p-6 text-red-400">
                        Error: {error}
                    </div>
                );
            }

            const { summary, products, maturity } = analytics || {};

            return (
                <div className="space-y-6">
                    {/* Maturity Progress */}
                    <div className="card p-4">
                        <div className="flex items-center justify-between mb-2">
                            <span className="text-gray-400">Business Maturity</span>
                            <span className="text-sm text-gray-300">
                                Day {maturity?.current_day} of {maturity?.maturity_days}
                            </span>
                        </div>
                        <div className="w-full bg-gray-700 rounded-full h-3">
                            <div
                                className="bg-gradient-to-r from-green-600 to-green-400 h-3 rounded-full transition-all duration-500"
                                style={{ width: `${Math.min(100, maturity?.maturity_percent || 0)}%` }}
                            ></div>
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                            Sales at {maturity?.maturity_percent?.toFixed(0)}% of full velocity
                        </div>
                    </div>

                    {/* Summary Cards */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="card p-4">
                            <div className="text-gray-400 text-sm">Revenue Today</div>
                            <div className="text-xl font-mono text-green-400">{formatMoney(summary?.revenue_today)}</div>
                        </div>
                        <div className="card p-4">
                            <div className="text-gray-400 text-sm">Revenue (7d)</div>
                            <div className="text-xl font-mono text-green-400">{formatMoney(summary?.revenue_7d)}</div>
                        </div>
                        <div className="card p-4">
                            <div className="text-gray-400 text-sm">Revenue (30d)</div>
                            <div className="text-xl font-mono text-green-400">{formatMoney(summary?.revenue_30d)}</div>
                        </div>
                        <div className="card p-4">
                            <div className="text-gray-400 text-sm">Gross Margin</div>
                            <div className="text-xl font-mono text-blue-400">{summary?.gross_margin?.toFixed(1)}%</div>
                        </div>
                    </div>

                    {/* Units Sold Row */}
                    <div className="grid grid-cols-3 gap-4">
                        <div className="card p-3 text-center">
                            <div className="text-gray-400 text-xs">Units Today</div>
                            <div className="text-lg font-mono">{formatNumber(summary?.units_today)}</div>
                        </div>
                        <div className="card p-3 text-center">
                            <div className="text-gray-400 text-xs">Units (7d)</div>
                            <div className="text-lg font-mono">{formatNumber(summary?.units_7d)}</div>
                        </div>
                        <div className="card p-3 text-center">
                            <div className="text-gray-400 text-xs">Units (30d)</div>
                            <div className="text-lg font-mono">{formatNumber(summary?.units_30d)}</div>
                        </div>
                    </div>

                    {/* Charts */}
                    {analytics?.daily_history?.length > 0 ? (
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="card p-4">
                                <h3 className="text-sm font-semibold text-gray-400 mb-3">Revenue & Profit Trend</h3>
                                <div style={{ height: '200px' }}>
                                    <canvas ref={revenueChartRef}></canvas>
                                </div>
                            </div>
                            <div className="card p-4">
                                <h3 className="text-sm font-semibold text-gray-400 mb-3">Units Sold</h3>
                                <div style={{ height: '200px' }}>
                                    <canvas ref={unitsChartRef}></canvas>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="card p-6 text-center text-gray-500">
                            <div className="text-lg mb-2">No Sales History Yet</div>
                            <div className="text-sm">Charts will appear after you advance a few days and make some sales.</div>
                        </div>
                    )}

                    {/* Product Performance Table */}
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold mb-4">Product Performance</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="text-gray-400 border-b border-gray-700">
                                        <th className="text-left py-2">Product</th>
                                        <th className="text-right py-2">Stock</th>
                                        <th className="text-right py-2">On Order</th>
                                        <th className="text-right py-2">Avg/Day</th>
                                        <th className="text-right py-2">Days Supply</th>
                                        <th className="text-right py-2">Revenue (7d)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {products?.map(p => (
                                        <tr key={p.product_id} className="border-b border-gray-800 hover:bg-gray-800/50">
                                            <td className="py-2 font-medium">{p.name}</td>
                                            <td className="text-right py-2 font-mono">{formatNumber(p.stock)}</td>
                                            <td className="text-right py-2 font-mono text-cyan-400">{p.on_order > 0 ? `+${formatNumber(p.on_order)}` : '-'}</td>
                                            <td className="text-right py-2 font-mono">{p.avg_daily_sales?.toFixed(1) || '0.0'}</td>
                                            <td className={`text-right py-2 font-mono ${getDaysSupplyColor(p.days_supply)}`}>
                                                {getDaysSupplyLabel(p.days_supply)}
                                            </td>
                                            <td className="text-right py-2 font-mono text-green-400">{formatMoney(p.revenue_7d)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <div className="mt-4 text-xs text-gray-500">
                            <span className="text-red-400">‚ö†Ô∏è &lt;3 days</span> = Reorder now |
                            <span className="text-yellow-400 ml-2">3-7 days</span> = Low stock |
                            <span className="text-green-400 ml-2">‚úì 7+ days</span> = OK
                        </div>
                    </div>
                </div>
            );
        }

        // Financials Tab Component
        function FinancialsTab({ financials, apDetails, formatMoney }) {
            const inc = financials?.income_statement || {};
            const bs = financials?.balance_sheet || {};
            const cf = financials?.cash_flow || {};

            return (
                <div className="space-y-6">
                    {/* Three Financial Statements Grid */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">

                        {/* INCOME STATEMENT */}
                        <div className="card p-6">
                            <h3 className="text-lg font-semibold mb-4 text-blue-400 border-b border-gray-700 pb-2">
                                Income Statement
                            </h3>
                            <div className="space-y-2 text-sm">
                                <div className="flex justify-between py-1">
                                    <span className="text-gray-400">Revenue</span>
                                    <span className="font-mono text-blue-400">{formatMoney(inc.revenue)}</span>
                                </div>
                                <div className="flex justify-between py-1">
                                    <span className="text-gray-400 pl-2">- Cost of Goods Sold</span>
                                    <span className="font-mono text-red-400">({formatMoney(inc.cogs)})</span>
                                </div>
                                <div className="flex justify-between py-2 border-t border-gray-700 font-medium">
                                    <span>= Gross Profit</span>
                                    <span className={`font-mono ${inc.gross_profit >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                        {formatMoney(inc.gross_profit)}
                                    </span>
                                </div>
                                <div className="flex justify-between py-1 text-xs text-gray-500">
                                    <span>Gross Margin</span>
                                    <span>{inc.gross_margin_percent || 0}%</span>
                                </div>
                                <div className="flex justify-between py-1">
                                    <span className="text-gray-400 pl-2">- Operating Expenses</span>
                                    <span className="font-mono text-red-400">({formatMoney(inc.operating_expenses)})</span>
                                </div>
                                <div className="flex justify-between py-2 border-t border-gray-700 border-double font-bold text-lg">
                                    <span>= Net Income</span>
                                    <span className={`font-mono ${inc.net_income >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                        {formatMoney(inc.net_income)}
                                    </span>
                                </div>
                            </div>
                        </div>

                        {/* BALANCE SHEET */}
                        <div className="card p-6">
                            <h3 className="text-lg font-semibold mb-4 text-purple-400 border-b border-gray-700 pb-2">
                                Balance Sheet
                            </h3>
                            <div className="space-y-2 text-sm">
                                {/* Assets Section */}
                                <div className="text-gray-400 font-medium text-xs uppercase tracking-wide">Assets</div>
                                <div className="flex justify-between py-1 pl-2">
                                    <span>Cash</span>
                                    <span className="font-mono text-green-400">{formatMoney(bs.assets?.cash)}</span>
                                </div>
                                <div className="flex justify-between py-1 pl-2">
                                    <span>Inventory</span>
                                    <span className="font-mono text-cyan-400">{formatMoney(bs.assets?.inventory)}</span>
                                </div>
                                <div className="flex justify-between py-1 border-t border-gray-700 font-medium">
                                    <span>Total Assets</span>
                                    <span className="font-mono">{formatMoney(bs.assets?.total)}</span>
                                </div>

                                {/* Liabilities Section */}
                                <div className="text-gray-400 font-medium text-xs uppercase tracking-wide mt-4">Liabilities</div>
                                <div className="flex justify-between py-1 pl-2">
                                    <span>Accounts Payable</span>
                                    <span className="font-mono text-red-400">{formatMoney(bs.liabilities?.accounts_payable)}</span>
                                </div>
                                <div className="flex justify-between py-1 border-t border-gray-700 font-medium">
                                    <span>Total Liabilities</span>
                                    <span className="font-mono">{formatMoney(bs.liabilities?.total)}</span>
                                </div>

                                {/* Equity Section */}
                                <div className="text-gray-400 font-medium text-xs uppercase tracking-wide mt-4">Equity</div>
                                <div className="flex justify-between py-1 pl-2">
                                    <span>Starting Capital</span>
                                    <span className="font-mono">{formatMoney(bs.equity?.starting_capital)}</span>
                                </div>
                                <div className="flex justify-between py-1 pl-2">
                                    <span>Retained Earnings</span>
                                    <span className={`font-mono ${bs.equity?.retained_earnings >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                        {formatMoney(bs.equity?.retained_earnings)}
                                    </span>
                                </div>
                                <div className="flex justify-between py-1 border-t border-gray-700 font-medium">
                                    <span>Total Equity</span>
                                    <span className="font-mono text-purple-400">{formatMoney(bs.equity?.total)}</span>
                                </div>

                                {/* Balance Check */}
                                <div className="flex justify-between py-2 mt-2 border-t border-gray-700 border-double text-xs">
                                    <span className="text-gray-500">A = L + E</span>
                                    <span className={bs.balanced ? 'text-green-500' : 'text-red-500'}>
                                        {bs.balanced ? '‚úì Balanced' : '‚úó Unbalanced'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        {/* CASH FLOW STATEMENT */}
                        <div className="card p-6">
                            <h3 className="text-lg font-semibold mb-4 text-cyan-400 border-b border-gray-700 pb-2">
                                Cash Flow Statement
                            </h3>
                            <div className="space-y-2 text-sm">
                                <div className="text-gray-400 font-medium text-xs uppercase tracking-wide">Operating Activities</div>
                                <div className="flex justify-between py-1 pl-2">
                                    <span>Cash from Sales</span>
                                    <span className="font-mono text-green-400">
                                        {formatMoney(cf.operating_activities?.cash_from_sales)}
                                    </span>
                                </div>
                                <div className="flex justify-between py-1 pl-2">
                                    <span>Inventory Purchases</span>
                                    <span className="font-mono text-red-400">
                                        {formatMoney(cf.operating_activities?.cash_for_inventory)}
                                    </span>
                                </div>
                                <div className="flex justify-between py-1 pl-2">
                                    <span>AP Payments</span>
                                    <span className="font-mono text-red-400">
                                        {formatMoney(cf.operating_activities?.cash_for_ap_payments)}
                                    </span>
                                </div>
                                <div className="flex justify-between py-1 pl-2">
                                    <span>Expenses Paid</span>
                                    <span className="font-mono text-red-400">
                                        {formatMoney(cf.operating_activities?.cash_for_expenses)}
                                    </span>
                                </div>
                                <div className="flex justify-between py-2 border-t border-gray-700 font-medium">
                                    <span>Net Cash from Operations</span>
                                    <span className={`font-mono ${cf.operating_activities?.net_cash_from_operations >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                        {formatMoney(cf.operating_activities?.net_cash_from_operations)}
                                    </span>
                                </div>

                                <div className="mt-4 pt-4 border-t border-gray-700">
                                    <div className="flex justify-between py-1">
                                        <span className="text-gray-400">Beginning Cash</span>
                                        <span className="font-mono">{formatMoney(cf.beginning_cash)}</span>
                                    </div>
                                    <div className="flex justify-between py-1">
                                        <span className="text-gray-400">+ Net Cash Flow</span>
                                        <span className={`font-mono ${cf.operating_activities?.net_cash_from_operations >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {formatMoney(cf.operating_activities?.net_cash_from_operations)}
                                        </span>
                                    </div>
                                    <div className="flex justify-between py-2 border-t border-gray-700 border-double font-bold">
                                        <span>= Ending Cash</span>
                                        <span className="font-mono text-cyan-400">{formatMoney(cf.ending_cash)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Quick Summary Row */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="card p-4 text-center">
                            <div className="text-gray-400 text-sm">Total Revenue</div>
                            <div className="text-xl font-bold text-blue-400">{formatMoney(inc.revenue)}</div>
                        </div>
                        <div className="card p-4 text-center">
                            <div className="text-gray-400 text-sm">Gross Margin</div>
                            <div className="text-xl font-bold text-green-400">{inc.gross_margin_percent || 0}%</div>
                        </div>
                        <div className="card p-4 text-center">
                            <div className="text-gray-400 text-sm">Net Income</div>
                            <div className={`text-xl font-bold ${inc.net_income >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                {formatMoney(inc.net_income)}
                            </div>
                        </div>
                        <div className="card p-4 text-center">
                            <div className="text-gray-400 text-sm">Total Equity</div>
                            <div className="text-xl font-bold text-purple-400">{formatMoney(bs.equity?.total)}</div>
                        </div>
                    </div>

                    {/* Accounts Payable Details */}
                    {apDetails && apDetails.length > 0 && (
                        <div className="card p-6">
                            <h3 className="text-lg font-semibold mb-4 text-red-400 border-b border-gray-700 pb-2">
                                Bills Due (Accounts Payable)
                            </h3>
                            <table className="w-full text-sm">
                                <thead className="text-gray-400">
                                    <tr>
                                        <th className="text-left pb-2">Vendor</th>
                                        <th className="text-left pb-2">PO #</th>
                                        <th className="text-right pb-2">Amount</th>
                                        <th className="text-right pb-2">Due Date</th>
                                        <th className="text-right pb-2">Days Until Due</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {apDetails.map((bill, idx) => (
                                        <tr key={idx} className="border-t border-gray-700">
                                            <td className="py-2">{bill.vendor_name}</td>
                                            <td className="py-2 text-gray-400">#{bill.po_number}</td>
                                            <td className="py-2 text-right font-mono text-red-400">
                                                {formatMoney(bill.amount_due)}
                                            </td>
                                            <td className="py-2 text-right text-gray-400">{bill.due_date}</td>
                                            <td className={`py-2 text-right font-mono ${
                                                bill.is_overdue ? 'text-red-500 font-bold' :
                                                bill.days_until_due <= 3 ? 'text-yellow-400' :
                                                'text-green-400'
                                            }`}>
                                                {bill.is_overdue ? `${Math.abs(bill.days_until_due)}d OVERDUE` :
                                                 bill.days_until_due === 0 ? 'TODAY' :
                                                 `${bill.days_until_due}d`}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot className="border-t-2 border-gray-600">
                                    <tr>
                                        <td colSpan="2" className="py-2 font-semibold">Total Payable</td>
                                        <td className="py-2 text-right font-mono font-bold text-red-400">
                                            {formatMoney(apDetails.reduce((sum, b) => sum + b.amount_due, 0))}
                                        </td>
                                        <td colSpan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
