<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Harvest v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const API_BASE_URL = 'http://127.0.0.1:5000';
        
        // --- HELPER & GENERIC COMPONENTS ---
        const SalesChart = ({ data }) => {
            if (!data || data.length < 2) return <div className="text-center text-gray-500 py-8">Not enough sales data to display a trend.</div>;
            const maxRevenue = Math.max(...data.map(d => d.daily_revenue), 0);
            const chartHeight = 150;
            const chartWidth = 300; 
            const points = data.map((d, i) => {
                const x = (i / (data.length - 1)) * chartWidth;
                const y = chartHeight - (d.daily_revenue / (maxRevenue || 1)) * chartHeight;
                return `${x},${y}`;
            }).join(' ');
            const startDateLabel = data.length < 30 ? "Day 1" : `${data.length} days ago`;
            return (
                <div>
                    <svg viewBox={`0 0 ${chartWidth} ${chartHeight}`} className="w-full h-auto">
                        <polyline fill="none" stroke="#38bdf8" strokeWidth="2" points={points}/>
                    </svg>
                    <div className="flex justify-between text-xs text-gray-400 mt-1">
                        <span>{startDateLabel}</span>
                        <span>Yesterday</span>
                    </div>
                </div>
            );
        };

        const PieChart = ({ data }) => {
            if (!data || data.length === 0) return <div className="text-center text-gray-500 py-8">No inventory to display.</div>;
            const colors = ['#38bdf8', '#fb7185', '#4ade80', '#facc15', '#a78bfa'];
            const totalValue = data.reduce((sum, item) => sum + item.category_value, 0);
            let cumulativePercent = 0;
            const slices = data.map((item, index) => {
                const percent = item.category_value / totalValue;
                const startAngle = cumulativePercent * 360;
                const endAngle = (cumulativePercent + percent) * 360;
                cumulativePercent += percent;
                const getCoords = (angle) => {
                    const radians = (angle - 90) * Math.PI / 180;
                    return [50 + 40 * Math.cos(radians), 50 + 40 * Math.sin(radians)];
                };
                const [startX, startY] = getCoords(startAngle);
                const [endX, endY] = getCoords(endAngle);
                const largeArcFlag = percent > 0.5 ? 1 : 0;
                const pathData = `M 50,50 L ${startX},${startY} A 40,40 0 ${largeArcFlag},1 ${endX},${endY} Z`;
                return <path key={item.category_name} d={pathData} fill={colors[index % colors.length]} />;
            });
            return (
                <div className="flex items-center">
                    <svg viewBox="0 0 100 100" className="w-40 h-40">{slices}</svg>
                    <div className="ml-4 text-sm space-y-2">
                        {data.map((item, index) => (
                            <div key={item.category_name} className="flex items-center">
                                <span className="w-3 h-3 rounded-full mr-2" style={{backgroundColor: colors[index % colors.length]}}></span>
                                <span>{item.category_name}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const VendorRow = ({ vendor, onOrder, cash, gameDate }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [products, setProducts] = useState([]);
            const [orderQtys, setOrderQtys] = useState({});
            const [shippingCost, setShippingCost] = useState(0);
            const fetchVendorProducts = useCallback(async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/vendors/${vendor.vendor_id}/products`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    setProducts(data);
                } catch (error) {
                    alert("Could not load products for this vendor. Is the API running?");
                }
            }, [vendor.vendor_id]);
            const toggleOpen = () => {
                if (!isOpen) { fetchVendorProducts(); }
                setIsOpen(!isOpen);
            };
            useEffect(() => { if (isOpen) { fetchVendorProducts(); } }, [isOpen, gameDate, fetchVendorProducts]);
            
            const orderSubtotal = useMemo(() => products.reduce((total, p) => {
                const qty = parseInt(orderQtys[p.product_id], 10) || 0;
                return total + (qty * p.unit_cost);
            }, 0), [products, orderQtys]);
            
            useEffect(() => {
                const timer = setTimeout(() => {
                    if (orderSubtotal > 0) {
                        const fetchShipping = async () => {
                            const response = await fetch(`${API_BASE_URL}/api/shipping_preview`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ vendor_id: vendor.vendor_id, subtotal: orderSubtotal })
                            });
                            const data = await response.json();
                            setShippingCost(data.shipping_cost || 0);
                        };
                        fetchShipping();
                    } else { setShippingCost(0); }
                }, 300); 
                return () => clearTimeout(timer);
            }, [orderSubtotal, vendor.vendor_id]);

            const grandTotal = orderSubtotal + shippingCost;

            const handleQtyChange = (productId, qty) => {
                setOrderQtys(prev => ({ ...prev, [productId]: qty }));
            };

            const handlePlaceOrder = () => {
                const itemsToOrder = Object.entries(orderQtys)
                    .filter(([_, qty]) => parseInt(qty, 10) > 0)
                    .reduce((acc, [id, qty]) => {
                        acc[id] = parseInt(qty, 10);
                        return acc;
                    }, {});
                if (Object.keys(itemsToOrder).length > 0) {
                    onOrder(vendor.vendor_id, itemsToOrder);
                } else {
                    alert('Please enter a quantity for at least one item.');
                }
            };
            return (
                <div className="border-t border-gray-700">
                    <button onClick={toggleOpen} className="w-full text-left p-4 hover:bg-gray-800 focus:outline-none transition-colors duration-150">
                        <div className="grid grid-cols-6 gap-4 items-center">
                            <span className="font-bold text-lg text-white col-span-2">{vendor.name}</span>
                            <span>üìç {vendor.location} (Est: {vendor.base_lead_time_days} days)</span>
                            <span className="text-sm text-gray-400">Terms: {vendor.payment_terms}</span>
                            <span>‚ù§Ô∏è {vendor.relationship_score}/100</span>
                            <span className="text-right">Min: ${vendor.minimum_order_value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                    </button>
                    {isOpen && (
                        <div className="bg-gray-800 p-4">
                            <div className="space-y-4">
                                {products.map(p => {
                                    const salesPerDay = p.sales_velocity_30_day / 30;
                                    const stockOutDays = salesPerDay > 0 ? Math.floor(p.current_stock / salesPerDay) : Infinity;
                                    return (
                                        <div key={p.product_id} className="grid grid-cols-5 gap-4 items-center pl-4">
                                            <div className="col-span-2">
                                                <p className="font-semibold">{p.name}</p>
                                                <div className="text-xs text-gray-400 flex flex-wrap gap-x-3 mt-1">
                                                    <span>Stock: {p.current_stock.toLocaleString()}</span>
                                                    <span>Sold (30d): {p.sales_velocity_30_day.toLocaleString()}</span>
                                                    {isFinite(stockOutDays) && <span>Empty in: ~{stockOutDays} days</span>}
                                                </div>
                                            </div>
                                            <div className="text-sm text-gray-400">
                                                <p>Cost: ${p.unit_cost.toFixed(2)}/unit</p>
                                                <p>Min Qty: {p.min_quantity}</p>
                                            </div>
                                            <div className="col-span-2 flex justify-end">
                                                <input type="number" step="100" min="0" placeholder="0" value={orderQtys[p.product_id] || ''} onChange={e => handleQtyChange(p.product_id, e.target.value)} className="bg-gray-900 border border-gray-600 rounded-md p-1 w-24 text-right focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            <div className="mt-4 flex justify-end items-center space-x-4">
                                <div className="text-right text-sm">
                                    <div>Subtotal: ${orderSubtotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    <div className="text-gray-400">Shipping: ${shippingCost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    <div className="font-semibold text-lg mt-1">Total: ${grandTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    {orderSubtotal > 0 && orderSubtotal < vendor.minimum_order_value && <div className="text-xs text-red-400">Below Minimum Order</div>}
                                </div>
                                <button onClick={handlePlaceOrder} disabled={orderSubtotal < vendor.minimum_order_value || orderSubtotal === 0} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md disabled:bg-gray-600 disabled:cursor-not-allowed">
                                    Place Order
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        const ProspectiveVendorRow = ({ vendor }) => {
            const progressPercent = Math.min((vendor.relationship_score / (vendor.unlock_progress.relationship_needed || 100)) * 100, 100);
            return (
                <div className="border-t border-gray-700 p-4">
                    <div className="grid grid-cols-5 gap-4 items-center">
                        <span className="font-bold text-lg text-gray-400 col-span-2">{vendor.name} ({vendor.vendor_type})</span>
                        <span className="text-gray-400">üìç {vendor.location}</span>
                        <span className="text-gray-400 col-span-2">
                            <div className="font-semibold">UNLOCK CONDITIONS:</div>
                            <ul className="list-disc list-inside text-sm">
                                {vendor.minimum_order_value >= 5000 && <li>Achieve ability to place a single order of ${vendor.minimum_order_value.toLocaleString()}</li>}
                                {vendor.unlock_progress.relationship_needed && <li>Achieve Relationship Score of {vendor.unlock_progress.relationship_needed}</li>}
                            </ul>
                        </span>
                    </div>
                    <div className="mt-2">
                        <p className="text-xs text-gray-400">Current Relationship: {vendor.relationship_score} / {vendor.unlock_progress.relationship_needed || 100}</p>
                        <div className="bg-gray-700 rounded-full h-2.5">
                            <div className="bg-blue-600 h-2.5 rounded-full" style={{width: `${progressPercent}%`}}></div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const ActiveEventsPanel = ({ gameDate }) => {
            const [activeEvents, setActiveEvents] = useState([]);
            
            useEffect(() => {
                const fetchEvents = async () => {
                    const res = await fetch(`${API_BASE_URL}/api/market_events/active`);
                    if (res.ok) setActiveEvents(await res.json());
                };
                fetchEvents();
            }, [gameDate]);
            
            if (activeEvents.length === 0) return null;
            
            return (
                <div className="bg-yellow-900 border border-yellow-600 rounded-lg p-4 mb-4">
                    <h3 className="text-yellow-200 font-bold mb-2">üåü Active Market Events</h3>
                    {activeEvents.map(event => (
                        <div key={event.event_id} className="text-yellow-100 text-sm mb-1">
                            <strong>{event.name}</strong> - {event.description}
                            <span className="text-yellow-300 ml-2">
                                (Ends: {new Date(event.end_date).toLocaleDateString()})
                            </span>
                        </div>
                    ))}
                </div>
            );
        };

        const BillsDuePanel = ({ gameDate }) => {
            const [bills, setBills] = useState([]);

            useEffect(() => {
                const fetchBills = async () => {
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/bills/upcoming`);
                        if (res.ok) {
                            setBills(await res.json());
                        }
                    } catch (e) {
                        console.error("Could not fetch upcoming bills", e);
                    }
                };
                fetchBills();
            }, [gameDate]);

            const calculateDaysUntilDue = (dueDate) => {
                const due = new Date(dueDate);
                const now = new Date(gameDate);
                due.setHours(0, 0, 0, 0);
                now.setHours(0, 0, 0, 0);
                const diffTime = due.getTime() - now.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            };

            return (
                <div className="mt-6 pt-4 border-t border-gray-700">
                    <h3 className="text-lg font-semibold mb-2 text-gray-300">Bills Due Soon</h3>
                    {bills.length === 0 ? (
                        <p className="text-sm text-gray-500">No upcoming payments.</p>
                    ) : (
                        <ul className="space-y-3">
                            {bills.map((bill, index) => {
                                const daysUntilDue = calculateDaysUntilDue(bill.due_date);
                                let dateText;
                                if (daysUntilDue < 0) {
                                    dateText = <span className="font-bold text-red-400">OVERDUE</span>;
                                } else if (daysUntilDue === 0) {
                                    dateText = <span className="font-bold text-yellow-400">Due Today</span>;
                                } else if (daysUntilDue === 1) {
                                    dateText = 'Due Tomorrow';
                                } else {
                                    dateText = `in ${daysUntilDue} days`;
                                }

                                return (
                                    <li key={index} className="text-sm">
                                        <div className="flex justify-between font-semibold text-gray-200">
                                            <span>{bill.vendor_name}</span>
                                            <span>${parseFloat(bill.amount_due).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                                        </div>
                                        <div className="text-xs text-gray-400 text-right">{dateText}</div>
                                    </li>
                                );
                            })}
                        </ul>
                    )}
                </div>
            );
        };
        
        {/* --- NEW COMPONENT ADDED HERE --- */}
        const PendingDeliveriesPanel = ({ gameDate, refreshTrigger }) => {
            const [orders, setOrders] = useState([]);
            const [expandedOrder, setExpandedOrder] = useState(null);
            const [orderDetails, setOrderDetails] = useState({});

            useEffect(() => {
                const fetchOrders = async () => {
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/purchase_orders/open`);
                        if (res.ok) setOrders(await res.json());
                    } catch (e) {
                        console.error("Could not fetch open POs", e);
                    }
                };
                fetchOrders();
            }, [gameDate, refreshTrigger]);

            const handleOrderClick = async (orderId) => {
                if (expandedOrder === orderId) {
                    setExpandedOrder(null);
                    return;
                }
                
                if (!orderDetails[orderId]) {
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/purchase_orders/${orderId}/details`);
                        if (res.ok) {
                            const details = await res.json();
                            setOrderDetails(prev => ({ ...prev, [orderId]: details }));
                        }
                    } catch (e) {
                        console.error("Could not fetch order details", e);
                    }
                }
                setExpandedOrder(orderId);
            };

            return (
                <div className="mt-6 pt-4 border-t border-gray-700">
                    <h3 className="text-lg font-semibold mb-2 text-gray-300">Pending Deliveries</h3>
                    {orders.length === 0 ? (
                        <p className="text-sm text-gray-500">No outstanding orders.</p>
                    ) : (
                        <ul className="space-y-3">
                            {orders.map((order, index) => (
                                <li key={index} className="text-sm">
                                    <div 
                                        onClick={() => handleOrderClick(order.order_id)}
                                        className="cursor-pointer hover:bg-gray-700 p-2 rounded transition-colors"
                                    >
                                        <div className="flex justify-between font-semibold text-gray-200">
                                            <span>{order.vendor_name} (PO #{order.order_id})</span>
                                            <span>${parseFloat(order.amount_due).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                                        </div>
                                        <div className="text-xs text-gray-400">
                                            Expected Arrival: {new Date(order.expected_arrival_date).toLocaleDateString()}
                                        </div>
                                    </div>
                                    {expandedOrder === order.order_id && orderDetails[order.order_id] && (
                                        <div className="mt-2 p-3 bg-gray-900 rounded border-l-2 border-blue-500">
                                            <div className="text-xs text-gray-300 mb-2">
                                                <div>Order Date: {new Date(orderDetails[order.order_id].order_date).toLocaleDateString()}</div>
                                                <div>Status: {orderDetails[order.order_id].status}</div>
                                            </div>
                                            <div className="space-y-1">
                                                {orderDetails[order.order_id].items.map((item, idx) => (
                                                    <div key={idx} className="flex justify-between text-xs">
                                                        <span className="text-gray-300">{item.product_name}</span>
                                                        <span className="text-gray-400">{item.quantity} √ó ${parseFloat(item.unit_cost).toFixed(2)}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        };


        // --- PAGE COMPONENTS ---
        
        const DashboardPage = ({ status, salesHistory }) => {
            const [dashboardData, setDashboardData] = useState({ inventory_by_category: [] });
            useEffect(() => {
                const fetchDashboardData = async () => {
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/dashboard_data`);
                        if(res.ok) setDashboardData(await res.json());
                    } catch (e) { console.error("Could not fetch dashboard data", e); }
                };
                fetchDashboardData();
            }, [status]);
            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-4 gap-6">
                        <div className="bg-gray-800 p-4 rounded-lg shadow"><div className="text-gray-400 text-sm">Cash on Hand</div><div className="text-2xl font-bold text-green-400">${status.cash.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div></div>
                        <div className="bg-gray-800 p-4 rounded-lg shadow"><div className="text-gray-400 text-sm">Inventory Value</div><div className="text-2xl font-bold">${status.total_inventory_value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div></div>
                        <div className="bg-gray-800 p-4 rounded-lg shadow"><div className="text-gray-400 text-sm">Accounts Payable</div><div className="text-2xl font-bold text-yellow-400">${status.accounts_payable.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div></div>
                        <div className="bg-gray-800 p-4 rounded-lg shadow"><div className="text-gray-400 text-sm">Outstanding Debt</div><div className="text-2xl font-bold text-red-400">${status.total_debt.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div></div>
                    </div>
                    <div className="grid grid-cols-3 gap-6">
                        <div className="col-span-2 bg-gray-800 p-4 rounded-lg shadow">
                            <h2 className="text-xl font-semibold border-b border-gray-700 pb-2 mb-2">30-Day Sales Trend</h2>
                            <SalesChart data={salesHistory} />
                        </div>
                        <div className="col-span-1 bg-gray-800 p-4 rounded-lg shadow">
                            <h2 className="text-xl font-semibold border-b border-gray-700 pb-2 mb-2">Inventory by Category</h2>
                            <PieChart data={dashboardData.inventory_by_category} />
                        </div>
                    </div>
                </div>
            );
        };

        const InventoryPage = ({ gameDate }) => {
            const [inventory, setInventory] = useState([]);
            const [unlocks, setUnlocks] = useState([]);
            const [filters, setFilters] = useState({ type: 'ALL', feel: 'ALL', sound: 'ALL' });
            const [sortConfig, setSortConfig] = useState({ key: 'name', direction: 'ascending' });
            const [editingPrices, setEditingPrices] = useState({});

            const fetchData = useCallback(async () => {
                const [invRes, unlocksRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/inventory`),
                    fetch(`${API_BASE_URL}/api/unlocks`)
                ]);
                if (invRes.ok) setInventory(await invRes.json());
                if (unlocksRes.ok) setUnlocks(await unlocksRes.json());
            }, []);

            useEffect(() => { fetchData(); }, [fetchData, gameDate]);
            
            const handleFilterChange = (filterName, value) => {
                setFilters(prev => ({ ...prev, [filterName]: value }));
            };

            const filterOptions = useMemo(() => {
                const options = {
                    type: new Set(['ALL']),
                    feel: new Set(['ALL']),
                    sound: new Set(['ALL']),
                };
                inventory.forEach(p => {
                    if (p.switch_type) options.type.add(p.switch_type);
                    if (p.switch_feel) options.feel.add(p.switch_feel);
                    if (p.sound_profile) options.sound.add(p.sound_profile);
                });
                return {
                    type: Array.from(options.type).sort(),
                    feel: Array.from(options.feel).sort(),
                    sound: Array.from(options.sound).sort(),
                };
            }, [inventory]);

            const sortedAndFilteredInventory = useMemo(() => {
                let filterableItems = [...inventory];
                
                if (filters.type !== 'ALL') filterableItems = filterableItems.filter(p => p.switch_type === filters.type);
                if (filters.feel !== 'ALL') filterableItems = filterableItems.filter(p => p.switch_feel === filters.feel);
                if (filters.sound !== 'ALL') filterableItems = filterableItems.filter(p => p.sound_profile === filters.sound);

                return filterableItems.sort((a, b) => {
                    if (a[sortConfig.key] < b[sortConfig.key]) {
                        return sortConfig.direction === 'ascending' ? -1 : 1;
                    }
                    if (a[sortConfig.key] > b[sortConfig.key]) {
                        return sortConfig.direction === 'ascending' ? 1 : -1;
                    }
                    return 0;
                });
            }, [inventory, filters, sortConfig]);

            const requestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                    direction = 'descending';
                }
                setSortConfig({ key, direction });
            };

            const handlePriceChange = (productId, value) => {
                setEditingPrices(prev => ({ ...prev, [productId]: value }));
            };

            const handlePriceUpdate = async (productId) => {
                const newPrice = editingPrices[productId];
                const response = await fetch(`${API_BASE_URL}/api/products/price`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_id: productId, price: newPrice })
                });
                const result = await response.json();
                alert(result.message);
                if(result.success) {
                    setEditingPrices(prev => {
                        const newPrices = {...prev};
                        delete newPrices[productId];
                        return newPrices;
                    });
                    fetchData();
                }
            };
            
            const getUnlockConditionText = (productId) => {
                const unlock = unlocks.find(u => u.id === productId);
                if(!unlock) return "Unlock condition not met.";
                return `Unlock at $${unlock.value.toLocaleString()} total revenue.`;
            }

            return (
                <div className="bg-gray-800 shadow rounded-lg p-6">
                    <h2 className="text-2xl font-bold border-b border-gray-700 pb-2 mb-4">Inventory & Pricing</h2>
                    
                    <div className="flex items-center space-x-6 mb-4 bg-gray-900/50 p-3 rounded-lg">
                        <div className="font-semibold text-gray-300">Filters:</div>
                        <div>
                            <label htmlFor="type-filter" className="block text-xs font-medium text-gray-400">Type</label>
                            <select id="type-filter" value={filters.type} onChange={e => handleFilterChange('type', e.target.value)} className="bg-gray-700 border-gray-600 rounded-md p-1 mt-1 text-sm focus:ring-blue-500 focus:border-blue-500">
                                {filterOptions.type.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                            </select>
                        </div>
                        <div>
                            <label htmlFor="feel-filter" className="block text-xs font-medium text-gray-400">Feel</label>
                            <select id="feel-filter" value={filters.feel} onChange={e => handleFilterChange('feel', e.target.value)} className="bg-gray-700 border-gray-600 rounded-md p-1 mt-1 text-sm focus:ring-blue-500 focus:border-blue-500">
                                {filterOptions.feel.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                            </select>
                        </div>
                        <div>
                            <label htmlFor="sound-filter" className="block text-xs font-medium text-gray-400">Sound</label>
                            <select id="sound-filter" value={filters.sound} onChange={e => handleFilterChange('sound', e.target.value)} className="bg-gray-700 border-gray-600 rounded-md p-1 mt-1 text-sm focus:ring-blue-500 focus:border-blue-500">
                                {filterOptions.sound.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                            </select>
                        </div>
                    </div>

                    <table className="w-full text-left">
                        <thead>
                            <tr className="border-b border-gray-600">
                                <th onClick={() => requestSort('name')} className="p-2 cursor-pointer hover:bg-gray-700">Product</th>
                                <th onClick={() => requestSort('stock')} className="p-2 cursor-pointer hover:bg-gray-700">Stock</th>
                                <th className="p-2">Price (Default)</th>
                                <th onClick={() => requestSort('switch_type')} className="p-2 cursor-pointer hover:bg-gray-700">Type</th>
                                <th onClick={() => requestSort('switch_feel')} className="p-2 cursor-pointer hover:bg-gray-700">Feel</th>
                                <th onClick={() => requestSort('sound_profile')} className="p-2 cursor-pointer hover:bg-gray-700">Sound</th>
                            </tr>
                        </thead>
                        <tbody>
                            {sortedAndFilteredInventory.map(p => (
                                <tr key={p.product_id} className={`border-b border-gray-700 ${p.status === 'LOCKED' ? 'opacity-50' : 'hover:bg-gray-700/50'}`}>
                                    <td className="p-2 font-semibold">{p.name}</td>
                                    <td className="p-2">{p.stock.toLocaleString()}</td>
                                    <td className="p-2 flex items-center">
                                        {p.status === 'UNLOCKED' ? (
                                            <>
                                                <input 
                                                    type="number"
                                                    step="0.01"
                                                    value={editingPrices[p.product_id] !== undefined ? editingPrices[p.product_id] : Number(p.current_selling_price)}
                                                    onChange={e => handlePriceChange(p.product_id, e.target.value)}
                                                    className="bg-gray-900 border border-gray-600 rounded-md p-1 w-24 text-right focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                />
                                                <span className="text-xs text-gray-400 ml-2">(${Number(p.default_price).toFixed(2)})</span>
                                                {editingPrices[p.product_id] !== undefined && 
                                                    <button onClick={() => handlePriceUpdate(p.product_id)} className="ml-2 text-xs bg-green-600 hover:bg-green-700 px-2 py-1 rounded">Save</button>
                                                }
                                            </>
                                        ) : (
                                            <div className="flex items-center" title={getUnlockConditionText(p.product_id)}>
                                                <span>üîí Locked</span>
                                            </div>
                                        )}
                                    </td>
                                    <td className="p-2">{p.switch_type}</td>
                                    <td className="p-2">{p.switch_feel}</td>
                                    <td className="p-2">{p.sound_profile}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };
        
        const SuppliersPage = ({ vendors, onOrder, cash, gameDate }) => {
             const [activeTab, setActiveTab] = useState('available');
             return (
                <div className="bg-gray-800 shadow rounded-lg">
                    <div className="p-4 border-b border-gray-700 flex space-x-4">
                        <button onClick={() => setActiveTab('available')} className={`py-2 px-4 rounded-lg font-semibold ${activeTab === 'available' ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600'}`}>Available Suppliers</button>
                        <button onClick={() => setActiveTab('prospective')} className={`py-2 px-4 rounded-lg font-semibold ${activeTab === 'prospective' ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600'}`}>Prospective Suppliers</button>
                    </div>
                    <div>
                        {activeTab === 'available' && vendors.available.map(v => <VendorRow key={v.vendor_id} vendor={v} onOrder={onOrder} cash={cash} gameDate={gameDate} />)}
                        {activeTab === 'prospective' && vendors.prospective.map(v => <ProspectiveVendorRow key={v.vendor_id} vendor={v} />)}
                    </div>
                </div>
             );
        };
        
        const MarketingPage = ({ onAction, gameDate }) => {
            const [offers, setOffers] = useState([]);
            const [targets, setTargets] = useState({ products: [], categories: [] });
            const [activeCampaigns, setActiveCampaigns] = useState([]);
            const [selectedTargets, setSelectedTargets] = useState({});
            const fetchData = useCallback(async () => {
                const [offersRes, targetsRes, activeRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/marketing/offers`),
                    fetch(`${API_BASE_URL}/api/marketing/targets`),
                    fetch(`${API_BASE_URL}/api/marketing/active`)
                ]);
                setOffers(await offersRes.json());
                setTargets(await targetsRes.json());
                setActiveCampaigns(await activeRes.json());
            }, []);
            useEffect(() => { fetchData(); }, [fetchData, gameDate]);
            const handleTargetChange = (offerId, targetId) => {
                setSelectedTargets(prev => ({ ...prev, [offerId]: targetId }));
            };
            const handleLaunch = async (offerId) => {
                const offer = offers.find(o => o.id === offerId);
                if (!offer) return;
                const targetId = selectedTargets[offerId];
                if (offer.target_type !== 'ALL' && !targetId) {
                    alert(`Please select a ${offer.target_type.toLowerCase()} to target.`);
                    return;
                }
                if (!confirm(`This will cost $${offer.cost.toFixed(2)}. Are you sure you want to launch this campaign?`)) return;
                const response = await fetch(`${API_BASE_URL}/api/marketing/launch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ offer_id: offerId, target_id: targetId })
                });
                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    onAction();
                    fetchData();
                }
            };
            return (
                <div className="grid grid-cols-3 gap-6">
                    <div className="col-span-2 space-y-6">
                        <div className="bg-gray-800 shadow rounded-lg p-6">
                            <h2 className="text-2xl font-bold border-b border-gray-700 pb-2 mb-4">Available Campaigns</h2>
                             <div className="space-y-4">
                                {offers.map(offer => {
                                    const targetList = offer.target_type === 'PRODUCT' ? targets.products : targets.categories;
                                    return (
                                        <div key={offer.id} className="bg-gray-700 p-4 rounded-lg">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <p className="font-bold text-xl text-white">{offer.name}</p>
                                                    <p className="text-sm text-gray-300 mt-1">{offer.description}</p>
                                                </div>
                                                <div className="text-right flex-shrink-0 ml-4">
                                                    <p className="text-lg font-semibold">${offer.cost.toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                                                    <p className="text-xs text-gray-400">for {offer.duration_days} days</p>
                                                </div>
                                            </div>
                                            <div className="mt-4 flex items-center space-x-4">
                                                {offer.target_type !== 'ALL' && (
                                                    <select value={selectedTargets[offer.id] || ''} onChange={(e) => handleTargetChange(offer.id, e.target.value)} className="bg-gray-900 border border-gray-600 rounded-md p-2 flex-grow focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                        <option value="">-- Select a {offer.target_type.toLowerCase()} --</option>
                                                        {targetList.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                                                    </select>
                                                )}
                                                <button onClick={() => handleLaunch(offer.id)} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Launch Campaign</button>
                                            </div>
                                        </div>
                                    );
                                })}
                             </div>
                        </div>
                    </div>
                    <div className="col-span-1">
                        <div className="bg-gray-800 shadow rounded-lg p-6">
                            <h2 className="text-2xl font-bold border-b border-gray-700 pb-2 mb-4">Active Campaigns</h2>
                            {activeCampaigns.length === 0 ? (<p className="text-gray-500">No active campaigns.</p>) : (
                                <ul className="space-y-3">
                                    {activeCampaigns.map(c => (
                                        <li key={c.campaign_id} className="bg-gray-700 p-3 rounded-md">
                                            <p className="font-semibold">{c.name}</p>
                                            <p className="text-xs text-gray-400">Ends on: {new Date(c.end_date).toLocaleDateString()}</p>
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                    </div>
                </div>
            );
        };
        
        const ExpensesPage = ({ gameDate }) => {
            const [expenses, setExpenses] = useState([]);
            useEffect(() => {
                const fetchExpenses = async () => {
                    const res = await fetch(`${API_BASE_URL}/api/expenses`);
                    setExpenses(await res.json());
                };
                fetchExpenses();
            }, [gameDate]);
            const totalMonthly = expenses.reduce((sum, exp) => sum + (exp.frequency === 'MONTHLY' ? parseFloat(exp.amount) : 0), 0);
            return (
                <div className="bg-gray-800 shadow rounded-lg p-6">
                    <div className="flex justify-between items-center border-b border-gray-700 pb-2 mb-4">
                        <h2 className="text-2xl font-bold">Recurring Expenses</h2>
                        <div className="text-right">
                            <div className="text-gray-400">Total Monthly Overhead</div>
                            <div className="text-xl font-bold">${totalMonthly.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    <div className="divide-y divide-gray-700">
                        {expenses.map((exp, index) => (
                            <div key={index} className="py-3 grid grid-cols-3 gap-4">
                                <span className="font-semibold">{exp.description}</span>
                                <span className="text-gray-400">{exp.account}</span>
                                <span className="text-right font-mono">${parseFloat(exp.amount).toLocaleString('en-US', {minimumFractionDigits: 2})} / {exp.frequency.toLowerCase().slice(0, -2)}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        const BankPage = ({ onAction, gameDate }) => {
            const [offers, setOffers] = useState([]);
            useEffect(() => {
                const fetchOffers = async () => {
                    const res = await fetch(`${API_BASE_URL}/api/loans/offers`);
                    setOffers(await res.json());
                };
                fetchOffers();
            }, [gameDate]);
            const handleAcceptLoan = async (offerId) => {
                if (!confirm("Are you sure you want to accept this loan? Payments will be automatically deducted each month.")) return;
                const response = await fetch(`${API_BASE_URL}/api/loans/accept`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ offer_id: offerId })
                });
                const result = await response.json();
                alert(result.message);
                if (result.success) { 
                    onAction(); 
                    fetchOffers();
                }
            };
            return (
                <div className="bg-gray-800 shadow rounded-lg p-6">
                    <h2 className="text-2xl font-bold border-b border-gray-700 pb-2 mb-4">The Bank of Digital Commerce</h2>
                    <p className="text-gray-400 mb-6">Inject capital into your business to fund growth, but be mindful of the monthly repayments.</p>
                    <div className="space-y-4">
                        {offers.length === 0 && <p>There are currently no loan offers available. You may already have an active loan.</p>}
                        {offers.map(offer => (
                            <div key={offer.id} className="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                                <div>
                                    <p className="font-bold text-xl text-white">Loan Offer: ${offer.principal.toLocaleString()}</p>
                                    <p className="text-sm text-gray-300">Terms: {offer.apr.toFixed(2)}% APR over {offer.term_months} months</p>
                                </div>
                                <div className="text-right">
                                    <p className="text-lg font-semibold">${offer.monthly_payment.toLocaleString('en-US', {minimumFractionDigits: 2})} / month</p>
                                    <button onClick={() => handleAcceptLoan(offer.id)} className="mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Accept Loan</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        function App() {
            const [status, setStatus] = useState(null);
            const [vendors, setVendors] = useState({ available: [], prospective: [] });
            const [salesHistory, setSalesHistory] = useState([]);
            const [activePage, setActivePage] = useState('dashboard');
            const [error, setError] = useState(null);
            const [refreshTrigger, setRefreshTrigger] = useState(0);

            const fetchData = useCallback(async () => {
                try {
                    setError(null);
                    const [statusRes, vendorsRes, salesRes] = await Promise.all([
                        fetch(`${API_BASE_URL}/api/status`),
                        fetch(`${API_BASE_URL}/api/vendors`),
                        fetch(`${API_BASE_URL}/api/sales_history`)
                    ]);
                    if (!statusRes.ok || !vendorsRes.ok || !salesRes.ok) throw new Error('API request failed');
                    const statusData = await statusRes.json();
                    setStatus(statusData);
                    setVendors(await vendorsRes.json());
                    setSalesHistory(await salesRes.json());
                } catch (err) { setError(err.message); }
            }, []);

            useEffect(() => { fetchData(); }, [fetchData]);
            
            const handleOrder = async (vendorId, items) => {
                const response = await fetch(`${API_BASE_URL}/api/order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vendor_id: vendorId, items })
                });
                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    await fetchData();
                    setRefreshTrigger(prev => prev + 1); // Trigger refresh for pending deliveries
                }
            };

            const handleAdvanceTime = async () => {
                const days = parseInt(prompt("Advance how many days?", 7), 10);
                if (!days || days <= 0) return;
                
                const response = await fetch(`${API_BASE_URL}/api/advance_time`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    let message = `Time advanced ${days} days!`;
                    const log = data.result.log;
                    
                    if (log && log.length > 0) {
                        message += "\n\n--- Event Log ---\n" + log.join("\n");
                    } else {
                        message += "\n\nNo significant events occurred.";
                    }
                    
                    alert(message);
                    await fetchData();
                }
            };
            
            if (error) return ( <div className="p-8 text-center text-red-400 bg-red-900 border border-red-400 rounded-lg m-4"><h2 className="text-2xl font-bold">Connection Error</h2><p className="mt-2">Could not connect to the simulation engine.</p><p className="font-mono mt-4 bg-gray-800 p-2 rounded">{error}</p><p className="mt-4">Please make sure the `api_v2.py` server is running and the database is set up.</p></div> );
            if (!status) return <div className="p-8 text-center">Loading Simulation...</div>;

            return (
                <div className="container mx-auto p-4 max-w-7xl">
                    <header className="bg-gray-800 shadow rounded-lg p-4 mb-6 flex justify-between items-center">
                        <div>
                            <h1 className="text-3xl font-bold text-white">Digital Harvest</h1>
                            <p className="text-gray-400">Supply Chain Simulator</p>
                        </div>
                        <div className="text-right">
                            <div className="text-2xl font-mono text-green-400">${status.cash.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div className="text-gray-400">{new Date(status.date).toDateString()}</div>
                        </div>
                        <button onClick={handleAdvanceTime} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 text-lg rounded-lg shadow-md">Advance Time</button>
                    </header>
                    
                    <ActiveEventsPanel gameDate={status.date} />

                    <div className="flex gap-6">
                        <nav className="w-1/5 bg-gray-800 shadow rounded-lg p-4 h-full">
                            <h2 className="text-xl font-semibold mb-4">Menu</h2>
                            <ul className="space-y-2">
                                <li><button onClick={() => setActivePage('dashboard')} className={`w-full text-left p-2 rounded-lg ${activePage === 'dashboard' ? 'bg-blue-600' : 'hover:bg-gray-700'}`}>üìà Dashboard</button></li>
                                <li><button onClick={() => setActivePage('inventory')} className={`w-full text-left p-2 rounded-lg ${activePage === 'inventory' ? 'bg-blue-600' : 'hover:bg-gray-700'}`}>üì¶ Inventory</button></li>
                                <li><button onClick={() => setActivePage('suppliers')} className={`w-full text-left p-2 rounded-lg ${activePage === 'suppliers' ? 'bg-blue-600' : 'hover:bg-gray-700'}`}>üöö Suppliers</button></li>
                                <li><button onClick={() => setActivePage('marketing')} className={`w-full text-left p-2 rounded-lg ${activePage === 'marketing' ? 'bg-blue-600' : 'hover:bg-gray-700'}`}>üì¢ Marketing</button></li>
                                <li><button onClick={() => setActivePage('expenses')} className={`w-full text-left p-2 rounded-lg ${activePage === 'expenses' ? 'bg-blue-600' : 'hover:bg-gray-700'}`}>üßæ Expenses</button></li>
                                <li><button onClick={() => setActivePage('bank')} className={`w-full text-left p-2 rounded-lg ${activePage === 'bank' ? 'bg-blue-600' : 'hover:bg-gray-700'}`}>üè¶ Bank</button></li>
                            </ul>
                            <BillsDuePanel gameDate={status.date} />
                            {/* --- NEW COMPONENT ADDED HERE --- */}
                            <PendingDeliveriesPanel gameDate={status.date} refreshTrigger={refreshTrigger} />
                        </nav>
                        <main className="w-4/5">
                            {activePage === 'dashboard' && <DashboardPage status={status} salesHistory={salesHistory} />}
                            {activePage === 'inventory' && <InventoryPage gameDate={status.date} />}
                            {activePage === 'suppliers' && <SuppliersPage vendors={vendors} onOrder={handleOrder} cash={status.cash} gameDate={status.date} />}
                            {activePage === 'marketing' && <MarketingPage onAction={fetchData} gameDate={status.date} />}
                            {activePage === 'expenses' && <ExpensesPage gameDate={status.date} />}
                            {activePage === 'bank' && <BankPage onAction={fetchData} gameDate={status.date} />}
                        </main>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
